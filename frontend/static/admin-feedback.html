<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin - Feedback</title>
  <style>
    :root {
      --bg: #0b111d;
      --surface: #101b2f;
      --surface-2: #13223a;
      --border: #2a3d5f;
      --text: #e8efff;
      --muted: #99add2;
      --accent: #39d8a8;
      --danger: #ff7f90;
      --shadow: 0 22px 56px rgba(0, 0, 0, 0.34);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "Space Grotesk", "Segoe UI", sans-serif;
      color: var(--text);
      background:
        radial-gradient(circle at 8% 8%, #1d3f74 0%, transparent 30%),
        radial-gradient(circle at 88% 0%, #1f5b46 0%, transparent 24%),
        var(--bg);
      min-height: 100vh;
    }

    .page {
      width: min(980px, 100%);
      margin: 0 auto;
      padding: 1rem;
      display: grid;
      gap: 0.8rem;
    }

    .top {
      position: sticky;
      top: 0.75rem;
      z-index: 20;
      background: rgba(14, 24, 41, 0.9);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 0.75rem 0.9rem;
      backdrop-filter: blur(8px);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.6rem;
      box-shadow: var(--shadow);
    }

    h1 {
      margin: 0;
      font-size: 1.05rem;
      letter-spacing: 0.02em;
    }

    .actions {
      display: flex;
      gap: 0.45rem;
      align-items: center;
    }

    button {
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 0.48rem 0.78rem;
      background: var(--surface);
      color: var(--text);
      cursor: pointer;
    }

    button.primary {
      background: linear-gradient(120deg, var(--accent), #55a8ff);
      border: none;
      color: #082335;
      font-weight: 700;
    }

    .status {
      color: var(--muted);
      font-size: 0.84rem;
      min-height: 1.2rem;
    }

    .status.error {
      color: var(--danger);
    }

    .list {
      display: grid;
      gap: 0.65rem;
      align-content: start;
    }

    .item {
      border: 1px solid var(--border);
      border-radius: 12px;
      background: linear-gradient(180deg, var(--surface) 0%, var(--surface-2) 100%);
      padding: 0.8rem;
      box-shadow: var(--shadow);
    }

    .feedback-text {
      margin: 0;
      white-space: pre-wrap;
      line-height: 1.5;
      font-size: 1rem;
      color: #eef4ff;
    }

    .meta {
      margin-top: 0.55rem;
      font-size: 0.76rem;
      color: var(--muted);
      letter-spacing: 0.01em;
    }

    .empty {
      border: 1px dashed var(--border);
      border-radius: 12px;
      padding: 1rem;
      color: var(--muted);
      background: rgba(16, 27, 47, 0.72);
    }
  </style>
</head>
<body>
  <main class="page">
    <section class="top">
      <h1>Feedback de usuarios</h1>
      <div class="actions">
        <button type="button" id="btn-back">Volver</button>
        <button type="button" id="btn-refresh" class="primary">Actualizar</button>
      </div>
    </section>
    <div id="status" class="status"></div>
    <section id="list" class="list"></section>
  </main>

  <script>
    (function () {
      "use strict";

      const statusEl = document.getElementById("status");
      const listEl = document.getElementById("list");
      const btnRefresh = document.getElementById("btn-refresh");
      const btnBack = document.getElementById("btn-back");

      function setStatus(text, isError) {
        statusEl.textContent = text || "";
        statusEl.classList.toggle("error", !!isError);
      }

      function formatDate(value) {
        if (!value) return "sin fecha";
        const d = new Date(value);
        if (Number.isNaN(d.getTime())) return "sin fecha";
        return d.toLocaleString("es-ES", {
          year: "numeric",
          month: "2-digit",
          day: "2-digit",
          hour: "2-digit",
          minute: "2-digit",
        });
      }

      function escapeHtml(input) {
        const div = document.createElement("div");
        div.textContent = String(input == null ? "" : input);
        return div.innerHTML;
      }

      function renderItems(items) {
        const list = Array.isArray(items) ? items : [];
        if (!list.length) {
          listEl.innerHTML = '<article class="empty">Todavía no hay feedback registrado.</article>';
          return;
        }
        listEl.innerHTML = list
          .map((item) => {
            const text = escapeHtml(item.feedback_text || "");
            const username = escapeHtml(item.username || "usuario");
            const timestamp = escapeHtml(formatDate(item.created_at));
            return [
              '<article class="item">',
              '<p class="feedback-text">' + text + '</p>',
              '<p class="meta">' + username + ' · ' + timestamp + '</p>',
              '</article>',
            ].join("");
          })
          .join("");
      }

      async function loadFeedback() {
        setStatus("Cargando feedback...", false);
        btnRefresh.disabled = true;
        try {
          const res = await fetch("/admin/feedback/list?limit=2000", { credentials: "include" });
          if (res.status === 401) throw new Error("No autenticado.");
          if (res.status === 403) throw new Error("Solo admin puede ver esta página.");
          if (!res.ok) throw new Error("No se pudo cargar el feedback.");
          const data = await res.json();
          renderItems(data.items || []);
          setStatus("Mostrando " + (Array.isArray(data.items) ? data.items.length : 0) + " entradas.", false);
        } catch (err) {
          renderItems([]);
          setStatus(err && err.message ? err.message : "Error cargando feedback.", true);
        } finally {
          btnRefresh.disabled = false;
        }
      }

      btnRefresh.addEventListener("click", loadFeedback);
      btnBack.addEventListener("click", function () {
        window.location.assign("/ui/");
      });

      loadFeedback();
    })();
  </script>
</body>
</html>
